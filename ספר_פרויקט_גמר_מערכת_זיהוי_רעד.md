# ספר פרויקט גמר

## מערכת לזיהוי וסיווג רעד פתולוגי באמצעות עיבוד אותות דיגיטלי

**Tremor Detection and Classification System Using Digital Signal Processing**

---

**שם המחבר:** עומר פטיש

**מוסד לימודים:** [שם המכללה/האוניברסיטה]

**בהנחיית:** [שם המנחה] - כמנחה המכללה

**תאריך:** ינואר 2026

**הוגש לשם מילוי חלקי של הדרישות לקבלת תואר**
**"בוגר במדעים B.Sc. בהנדסת חשמל ואלקטרוניקה"**

---

## תקציר

הפרויקט בוצע במסגרת תכן הנדסי פנימי (פרויקט גמר) במחלקה להנדסת חשמל ואלקטרוניקה.

**מטרת הפרויקט:**
פיתוח מערכת אוטומטית לזיהוי וסיווג רעד פתולוגי (Pathological Tremor) בזמן אמת באמצעות חיישן תנועה תלת-ציר (MPU6050) ועיבוד אותות דיגיטלי מתקדם. המערכת מיועדת לסייע בזיהוי מוקדם של מחלות נוירולוגיות כגון מחלת פרקינסון (Parkinson's Disease) ורעד אסנציאלי (Essential Tremor).

**רקע לפרויקט:**
רעד פתולוגי הוא אחד הסימפטומים השכיחים במחלות נוירולוגיות ומשפיע על כ-10 מיליון בני אדם ברחבי העולם. אבחון מוקדם ומעקב רציף אחר התפתחות הרעד חיוניים לטיפול יעיל. המערכות הקיימות כיום מבוססות על הערכה סובייקטיבית של נוירולוג או על ציוד יקר ומסורבל המצוי במעבדות מחקר בלבד.

**תיאור המערכת:**
המערכת מורכבת משני חלקים עיקריים:

1. **מערכת רכישת נתונים (Data Acquisition):**
   - מבוססת על בקר ESP32 עם חיישן תנועה MPU6050
   - דגימה בקצב 100 Hz של תאוצה תלת-צירית
   - תקשורת USB Serial לבקר Raspberry Pi 4
   - ממשק משתמש עם לחצן התחלה, תצוגת OLED ונוריות LED

2. **מערכת עיבוד ואנליזה (Processing & Analysis):**
   - מבוססת על Raspberry Pi 4 עם Python
   - עיבוד אותות בזמן אמת: סינון Butterworth Order 4, ניתוח ספקטרלי (PSD)
   - סיווג אוטומטי של סוג הרעד: Rest Tremor (3-7 Hz), Essential Tremor (6-12 Hz), Mixed Tremor
   - ממשק גרפי MATLAB-style עם 4 לשוניות עצמאיות לניתוח מפורט
   - שמירת נתונים לקבצי CSV ולוגים

**עקרון הפעולה:**
החיישן MPU6050 ממוקם על היד/אצבע של המשתמש ודוגם את תנועת התאוצה בשלושה צירים. הנתונים מועברים ב-100 Hz לבקר ESP32 המבצע דגימה ראשונית ומעביר את הנתונים ב-USB Serial ל-Raspberry Pi 4.

הנתונים עוברים עיבוד דיגיטלי מתקדם הכולל:
- הסרת DC offset (הסרת רכיב כבידה)
- סינון Butterworth Order 4 בשלושה טווחי תדר: 3-12 Hz (כללי), 3-7 Hz (רעד מנוחה), 6-12 Hz (רעד אסנציאלי)
- חישוב וקטור מוצא (Resultant Vector) עבור ניתוח בלתי תלוי בכיוון
- ניתוח PSD באמצעות שיטת Welch עם חלונות של 4 שניות וחפיפה 50%
- חישוב מדדים קליניים: RMS, Peak Frequency, Band Power, Power Ratio
- סיווג אוטומטי של סוג הרעד לפי יחס הספק בין התדרים

**אימות המערכת:**
על מנת לאמת את דיוק האלגוריתם, פותחה מערכת סימולציה מבוססת מנוע DC מבוקר (L298N Motor Driver). המנוע מייצר רעידות בתדרים מוגדרים (4-6 Hz עבור רעד מנוחה, 8-10 Hz עבור רעד אסנציאלי) ומאפשר אימות כמותי של יכולת הזיהוי והסיווג.

נערכו שתי בדיקות עיקריות:
1. **Ground Truth Validation:** חיישן מחובר ישירות למנוע - הצלחה 100% בזיהוי תדר דומיננטי
2. **Biomechanical Damping Test:** יד אוחזת במנוע, חיישן על אצבע - הצלחה 95% בזיהוי סוג רעד

**תוצאות:**
המערכת הוכיחה יכולת זיהוי וסיווג מדויקת של רעד פתולוגי:
- דיוק זיהוי תדר דומיננטי: ±0.25 Hz (רזולוציית Welch)
- דיוק סיווג סוג רעד: 100% בתנאים מבוקרים (מנוע), 95% בתנאים ריאליסטיים
- זמן עיבוד: ~2 דקות עבור הקלטה של 120 שניות
- פורמט פלט: ויזואליזציה גרפית + מדדים כמותיים + שמירת נתונים

**תרומה מדעית והנדסית:**
1. מימוש מערכת זיהוי רעד בעלות נמוכה (~$100) מבוססת רכיבים פתוחים
2. פיתוח אלגוריתם סיווג מבוסס יחס ספק בין תדרי רעד
3. יישום מערכת אימות מבוססת מנוע לאימות כמותי
4. תיעוד מפורט של שרשרת עיבוד האותות מקצה לקצה

**מילות מפתח:**
רעד פתולוגי, עיבוד אותות דיגיטלי, מחלת פרקינסון, MPU6050, Raspberry Pi, ESP32, סינון Butterworth, ניתוח PSD, Welch's Method, סיווג רעד

---

## תוכן עניינים

### 1. מבוא ........................................................................................ 1
   1.1 רקע כללי .................................................................................... 1
   1.2 הגדרת הבעיה ............................................................................. 2
   1.3 מטרות הפרויקט .......................................................................... 3
   1.4 היקף הפרויקט ............................................................................ 3

### 2. תיאור המערכת ........................................................................... 4
   2.1 הגדרה פונקציונאלית ................................................................. 4
   2.2 מפרט פונקציונאלי ...................................................................... 5
   2.3 מפרט טכני .................................................................................. 6
      2.3.1 טבלת פירוט מכלולי המערכת ............................................. 6
      2.3.2 תרשים מלבנים .................................................................. 9
      2.3.3 עקרון פעולת המערכת ....................................................... 10

### 3. רקע תיאורטי ועקרונות עיבוד אותות .......................................... 11
   3.1 רעד פתולוגי - סקירה קלינית ..................................................... 11
      3.1.1 רעד מנוחה (Rest Tremor) ................................................. 11
      3.1.2 רעד אסנציאלי (Essential Tremor) ..................................... 12
      3.1.3 רעד מעורב (Mixed Tremor) ............................................... 12
   3.2 עיבוד אותות דיגיטלי ................................................................. 13
      3.2.1 סינון Butterworth .............................................................. 13
      3.2.2 ניתוח PSD - שיטת Welch ................................................. 14
      3.2.3 אינטגרציה טרפזואידית לחישוב הספק ................................. 15
   3.3 מדדים קליניים .......................................................................... 16
      3.3.1 RMS (Root Mean Square) ................................................. 16
      3.3.2 Band Power ...................................................................... 16
      3.3.3 Power Ratio ...................................................................... 17

### 4. מטלות ...................................................................................... 18
   4.1 מטלות הנדסיות ברמת מפרט הדרישות ...................................... 18
   4.2 ביצוע המטלות ע"י המתמחה ..................................................... 19
      4.2.1 שלבי התכנון ...................................................................... 19
      4.2.2 תכנון אב ............................................................................ 20
      4.2.3 תכנון חומרה ...................................................................... 22
      4.2.4 תכנון תוכנה ....................................................................... 24
      4.2.5 תרשימי זרימה ................................................................... 26
      4.2.6 מימוש מערכת הרכישה (ESP32) ......................................... 28
      4.2.7 מימוש מערכת העיבוד (Raspberry Pi) ................................. 30
      4.2.8 מימוש מערכת האימות (Motor Simulation) ......................... 32
   4.3 בעיות ואתגרים הנדסיים ............................................................. 34

### 5. בדיקות ותוצאות ........................................................................ 36
   5.1 בדיקות תקינות מערכת .............................................................. 36
   5.2 אימות עם מנוע - Ground Truth .................................................. 37
      5.2.1 סדרת רעד מנוחה (4-6 Hz) ................................................ 37
      5.2.2 סדרת רעד אסנציאלי (8-10 Hz) ......................................... 39
   5.3 אימות עם דמפינג ביומכני ........................................................... 41
   5.4 בדיקה על נבדק בריא .................................................................. 42
   5.5 ניתוח תוצאות ............................................................................. 43

### 6. סיכום ודיון ................................................................................ 45
   6.1 הצורך בפרויקט ........................................................................... 45
   6.2 סיכום ומסקנות .......................................................................... 45
   6.3 תוספות עתידיות ......................................................................... 46
   6.4 עמידה בדרישות ......................................................................... 47

### 7. סימוכין ...................................................................................... 48

### נספחים
   נספח א': קוד ESP32 (esp32_usb_serial_safe.ino) ............................ 50
   נספח ב': קוד Raspberry Pi מנתח Offline (offline_analyzer.py) ...... 55
   נספח ג': קוד בקר מנוע (motor_control.py) .................................... 70
   נספח ד': תיעוד שרשרת עיבוד אותות ................................................ 75

---

## תוכן איורים

איור 1: תרשים מלבנים כללי של המערכת ............................................. 9
איור 2: תרשים זרימה - מערכת רכישה (ESP32) .................................. 26
איור 3: תרשים זרימה - מערכת עיבוד (Raspberry Pi) ......................... 27
איור 4: ממשק גרפי - Figure 1 (Filters & Metrics) ................................ 31
איור 5: ממשק גרפי - Figure 2 (Dominant Axis Analysis) ..................... 31
איור 6: ממשק גרפי - Figure 3 (Resultant Vector Analysis) .................. 31
איור 7: ממשק גרפי - Figure 4 (PSD Analysis) ..................................... 31
איור 8: תרשים חיבורים - ESP32 + MPU6050 ..................................... 22
איור 9: תרשים חיבורים - L298N Motor Driver .................................... 33
איור 10: תדרי מנוע לעומת תדר זיהוי - רעד מנוחה .............................. 38
איור 11: תדרי מנוע לעומת תדר זיהוי - רעד אסנציאלי ......................... 40
איור 12: PSD Comparison - Rest vs Essential ..................................... 43
איור 13: Power Ratio Distribution .................................................... 44

---

## תוכן טבלאות

טבלה 1: מכלולי מערכת רכישת נתונים (ESP32) ................................... 7
טבלה 2: מכלולי מערכת עיבוד (Raspberry Pi 4) .................................. 8
טבלה 3: מכלולי מערכת אימות (Motor Simulation) ............................. 8
טבלה 4: פרמטרי סינון Butterworth ................................................... 14
טבלה 5: פרמטרי ניתוח Welch PSD ................................................... 15
טבלה 6: סיכום תוצאות אימות מנוע - רעד מנוחה ................................ 38
טבלה 7: סיכום תוצאות אימות מנוע - רעד אסנציאלי ........................... 40
טבלה 8: סטטוס עמידה בדרישות הפרויקט ......................................... 47

---

## תוכן גרפים

גרף 1: תגובת תדר Butterworth Order 4 - Magnitude .......................... 21
גרף 2: תגובת תדר Butterworth Order 4 - Phase ................................ 21
גרף 3: PSD - קובץ דוגמה 141523 (Essential Tremor) ......................... 39
גרף 4: PSD - קובץ דוגמה 160502 (Mixed Tremor) ............................. 42
גרף 5: השוואת Band Power - Rest vs Essential .................................. 43

---

## רשימת קיצורים

**ADC** - Analog to Digital Converter
**API** - Application Programming Interface
**CSV** - Comma Separated Values
**DC** - Direct Current
**DMA** - Direct Memory Access
**DSP** - Digital Signal Processing
**FIFO** - First In First Out
**GPIO** - General Purpose Input/Output
**GUI** - Graphical User Interface
**Hz** - Hertz (יחידת תדר)
**I2C** - Inter-Integrated Circuit
**IMU** - Inertial Measurement Unit
**LED** - Light Emitting Diode
**OLED** - Organic Light Emitting Diode
**PC** - Personal Computer
**PSD** - Power Spectral Density
**PWM** - Pulse Width Modulation
**RMS** - Root Mean Square
**RPM** - Revolutions Per Minute
**SPI** - Serial Peripheral Interface
**UART** - Universal Asynchronous Receiver Transmitter
**USB** - Universal Serial Bus
**Wi-Fi** - Wireless Fidelity

---

# פרק 1: מבוא

## 1.1 רקע כללי

רעד פתולוגי (Pathological Tremor) הוא אחד הסימפטומים השכיחים ביותר במחלות נוירולוגיות ומשפיע על כ-10 מיליון בני אדם ברחבי העולם. רעד זה מתבטא בתנועות לא רצוניות מתנודדות של איבר או חלק מהגוף, בתדר קבוע יחסית, ויכול להשפיע באופן משמעותי על איכות החיים, היכולת לבצע פעולות יומיומיות ועל העצמאות של החולים.

שני סוגי הרעד הפתולוגי השכיחים ביותר הם:

1. **רעד מנוחה (Rest Tremor)** - מאפיין מחלת פרקינסון, מופיע בעיקר בזמן מנוחה בטווח תדרים 3-7 Hz
2. **רעד אסנציאלי (Essential Tremor)** - מופיע בעיקר בזמן פעילות או החזקת תנוחה, בטווח תדרים 6-12 Hz

אבחון מדויק וזיהוי מוקדם של סוג הרעד הפתולוגי הוא קריטי עבור:
- בחירת טיפול תרופתי מתאים
- מעקב אחר התקדמות המחלה
- הערכת יעילות הטיפול
- קבלת החלטות לגבי התערבויות נוספות (כגון ניתוח DBS)

### השיטות הקיימות כיום לזיהוי רעד:

**1. הערכה קלינית ידנית:**
- מבוססת על שיפוט סובייקטיבי של נוירולוג
- משתמשת בסקאלות כמו UPDRS (Unified Parkinson's Disease Rating Scale)
- בעיות: חוסר אובייקטיביות, תלות בניסיון הרופא, אין מעקב כמותי לאורך זמן

**2. מערכות מעבדתיות מסחריות:**
- מבוססות על חיישנים אלקטרומגנטיים או מצלמות תנועה
- עלות גבוהה מאוד ($50,000-$200,000)
- מסורבלות ונדרש ציוד נייח
- אינן זמינות למרבית המרפאות והחולים

**3. מערכות ניידות מחקריות:**
- במחקרים אקדמיים, פותחו מערכות ניידות מבוססות IMU
- רובן לא הגיעו לשלב מסחרי
- חסרה סטנדרטיזציה בין מערכות שונות

### הצורך בפרויקט זה:

קיים צורך ברור במערכת:
- **זולה** - מבוססת רכיבים פתוחים ונגישים ($100-200)
- **ניידת** - ניתן להפעיל בבית, בקליניקה או במרפאה
- **אובייקטיבית** - מדידות כמותיות חזרתיות
- **ידידותית למשתמש** - אינה דורשת הכשרה מורכבת
- **מבוססת מדעית** - אלגוריתמים מבוססי מחקר בעיבוד אותות

פרויקט זה בא לענות על צורך זה ולהציג פתרון מעשי, זול ויעיל לזיהוי וסיווג רעד פתולוגי.

---

## 1.2 הגדרת הבעיה

**הבעיה המרכזית:**
כיצד ניתן לזהות ולסווג באופן אוטומטי, אובייקטיבי ומדויק את סוג הרעד הפתולוגי (Rest vs Essential vs Mixed) באמצעות חיישן תנועה זול ועיבוד אותות דיגיטלי?

**אתגרים טכניים:**

1. **אתגר 1: זיהוי רעד מתוך רעש**
   - תנועות יד טבעיות (voluntary movements) יוצרות רעש ברקע
   - רכיב כבידה (gravity) משנה את קריאות המדידה בכל כיוון
   - רעידות סביבתיות (רכב, מכונות) יכולות להטעות את המערכת

2. **אתגר 2: הפרדה בין סוגי רעד**
   - טווחי התדרים חופפים חלקית (6-7 Hz נמצא בשני הטווחים)
   - חולים עם Mixed Tremor מציגים שני סוגי רעד בו-זמנית
   - עוצמת הרעד משתנה לאורך זמן (amplitude modulation)

3. **אתגר 3: מדידה אובייקטיבית**
   - המערכת חייבת לתת מדדים כמותיים חזרתיים
   - דיוק המדידה חייב להיות ברמה קלינית (±0.25 Hz לפחות)
   - המערכת צריכה להיות robust לשינויים בתנאי מדידה

4. **אתגר 4: אימות המערכת**
   - כיצד ניתן לאמת שהמערכת עובדת נכון ללא גישה למטופלים אמיתיים?
   - יש צורך ב-ground truth לבדיקת דיוק הזיהוי
   - יש צורך לבדוק robustness בתנאים שונים

**שאלות מחקר:**

1. האם סינון Butterworth Order 4 מספק הפרדה מספקת בין רכיבי הרעד?
2. האם ניתוח PSD בשיטת Welch מספק רזולוציה מספקת (0.25 Hz)?
3. האם יחס הספק (Power Ratio) בין שני טווחי התדרים מהווה קריטריון אמין לסיווג?
4. האם ניתן לאמת את המערכת באמצעות מנוע מבוקר?
5. עד כמה המערכת רגישה לדמפינג ביומכני (biological damping)?

---

## 1.3 מטרות הפרויקט

**מטרה ראשית:**
פיתוח מערכת אוטומטית ואובייקטיבית לזיהוי וסיווג רעד פתולוגי, מבוססת עיבוד אותות דיגיטלי מתקדם וחיישן תנועה זול.

**מטרות משנה:**

**1. פיתוח תשתית רכישת נתונים:**
- בניית מערכת רכישה מבוססת ESP32 + MPU6050
- דגימה בקצב 100 Hz עם FIFO buffer למניעת אובדן נתונים
- תקשורת יציבה ב-USB Serial
- ממשק משתמש עם תצוגה, לחצנים ונוריות

**2. פיתוח אלגוריתם עיבוד אותות:**
- מימוש סינון Butterworth Order 4 בשלושה טווחי תדר
- חישוב PSD בשיטת Welch עם חלונות 4 שניות
- חישוב מדדים קליניים: RMS, Band Power, Dominant Frequency
- סיווג אוטומטי לפי Power Ratio

**3. פיתוח ממשק גרפי מתקדם:**
- ויזואליזציה MATLAB-style עם 4 לשוניות עצמאיות
- הצגת תוצאות ניתוח בזמן אמת
- ייצוא נתונים לקבצי CSV וגרפים

**4. פיתוח מערכת אימות:**
- בניית מערכת סימולציה מבוססת מנוע DC
- יצירת סדרות תדרים מוגדרות (4-6 Hz, 8-10 Hz)
- אימות כמותי של דיוק הזיהוי והסיווג

**5. תיעוד ואפיון:**
- תיעוד מפורט של שרשרת עיבוד האותות
- הוכחת עקביות פנימית (internal consistency)
- השוואה למחקרים קיימים

---

## 1.4 היקף הפרויקט

**מה נכלל בפרויקט:**

✅ פיתוח מערכת רכישת נתונים (ESP32 + MPU6050)
✅ פיתוח אלגוריתם עיבוד אותות מתקדם (Butterworth, Welch PSD)
✅ פיתוח ממשק גרפי MATLAB-style
✅ פיתוח מערכת אימות (Motor Simulation)
✅ בדיקות אימות מקיפות (Ground Truth + Damping)
✅ תיעוד מלא של שרשרת העיבוד
✅ הכנת ספר פרויקט ומצגת

**מה לא נכלל בפרויקט (מוגדר כעבודה עתידית):**

❌ בדיקה על מטופלים אמיתיים עם אבחנות מאושרות (דורש אישור IRB)
❌ השוואה למערכות מסחריות (אין גישה לציוד)
❌ למידת מכונה (Machine Learning) - נשמרים נתונים לעבודה עתידית
❌ מערכת real-time על המכשיר הנייד (הניתוח נעשה offline)
❌ אפליקציה ניידת או ענן (Cloud)

**גבולות הפרויקט:**

- **דגימה:** 100 Hz (מספק לתדרים עד 50 Hz לפי Nyquist)
- **משך הקלטה:** 120 שניות (מספק לניתוח PSD אמין)
- **רזולוצית PSD:** 0.25 Hz (מספק להפרדת טווחי תדרים)
- **אוכלוסיית יעד:** מבוגרים עם רעד פתולוגי (לא ילדים)
- **מיקום חיישן:** יד/אצבע בלבד (לא גפיים אחרות)

---

# פרק 2: תיאור המערכת

## 2.1 הגדרה פונקציונאלית

מערכת אוטומטית לרכישה, עיבוד, ניתוח וסיווג של נתוני תנועת רעד, המספקת מדדים כמותיים ואובייקטיביים לצורך אבחון והערכת חומרת רעד פתולוגי.

---

## 2.2 מפרט פונקציונאלי

### מערכת רכישת נתונים (ESP32):

1. יכולת קליטת נתוני תאוצה תלת-צירית בקצב 100 Hz
2. יכולת אחסון זמני ב-FIFO buffer (1024 דגימות)
3. יכולת תקשורת USB Serial יציבה (115200 baud)
4. יכולת הצגת סטטוס על תצוגת OLED
5. יכולת בקרת הקלטה (התחלה/עצירה/המשך) באמצעות לחצן
6. יכולת חיווי סטטוס באמצעות נוריות LED
7. יכולת עבודה רציפה למשך 120+ שניות

### מערכת עיבוד ואנליזה (Raspberry Pi):

8. יכולת קליטת נתונים ב-USB Serial בזמן אמת
9. יכולת סינון Butterworth Order 4 בשלושה טווחי תדר
10. יכולת חישוב PSD בשיטת Welch (4s windows, 50% overlap)
11. יכולת חישוב מדדים קליניים (RMS, Power, Frequency)
12. יכולת סיווג אוטומטי לסוגי רעד
13. יכולת ויזואליזציה גרפית MATLAB-style
14. יכולת שמירת נתונים לקבצי CSV
15. יכולת ייצוא גרפים לתמונות

### מערכת אימות (Motor Simulation):

16. יכולת יצירת רעידות בתדרים מוגדרים (0.1 Hz resolution)
17. יכולת הרצת סדרות תדרים אוטומטיות (120s sequences)
18. יכולת בקרת עוצמה (PWM 0-100%)
19. יכולת הפעלה באמצעות לחצן או שורת פקודה

---

## 2.3 מפרט טכני

### 2.3.1 טבלת פירוט מכלולי המערכת

**טבלה 1: מכלולי מערכת רכישת נתונים (ESP32)**

| מספר | שם המכלול | תפקיד | פרמטרים מדידים |
|------|-----------|-------|----------------|
| 1 | מכלול חישה - חיישן תנועה MPU6050 | דגימת תאוצה תלת-צירית (Ax, Ay, Az) בקצב 100 Hz | טווח: ±2g, ±4g, ±8g, ±16g<br>רזולוציה: 16-bit<br>רעש: 0.01 g RMS |
| 2 | מכלול בקרה - ESP32 Development Board | עיבוד ראשוני, ניהול FIFO, תקשורת USB Serial | מעבד: Dual-core 240 MHz<br>זיכרון: 520 KB SRAM<br>תקשורת: USB, I2C, SPI |
| 3 | מכלול תצוגה - OLED 128x64 | הצגת סטטוס, מספר דגימות, זמן הקלטה | גודל: 0.96"<br>רזולוציה: 128x64<br>תקשורת: I2C |
| 4 | מכלול בקרת משתמש - Push Button + LEDs | התחלה/עצירה/המשך הקלטה, חיווי סטטוס | לחצן: Pull-up<br>LED ירוק: הקלטה<br>LED אדום: שגיאה |

**טבלה 2: מכלולי מערכת עיבוד (Raspberry Pi 4)**

| מספר | שם המכלול | תפקיד | פרמטרים מדידים |
|------|-----------|-------|----------------|
| 1 | מכלול בקרה - Raspberry Pi 4 Model B | עיבוד אותות מתקדם, ניתוח PSD, סיווג רעד, ויזואליזציה | מעבד: Quad-core 1.5 GHz<br>זיכרון: 4 GB RAM<br>אחסון: 64 GB SD |
| 2 | מכלול תקשורת USB Serial | קליטת נתונים מ-ESP32 בזמן אמת | קצב: 115200 baud<br>פורמט: "timestamp,ax,ay,az" |
| 3 | מכלול עיבוד אותות | סינון Butterworth, ניתוח PSD, חישוב מדדים | Python 3<br>NumPy, SciPy<br>Matplotlib |

**טבלה 3: מכלולי מערכת אימות (Motor Simulation)**

| מספר | שם המכלול | תפקיד | פרמטרים מדידים |
|------|-----------|-------|----------------|
| 1 | מכלול בקרת מנוע - L298N Motor Driver | בקרת PWM ומהירות מנוע DC | מתח: 12V<br>זרם מקס: 2A<br>PWM: 0-100% |
| 2 | מנוע DC 12V | יצירת רעידות מכניות בתדרים מוגדרים | RPM: 0-3000<br>מומנט: 0.5 Nm |
| 3 | בקר Raspberry Pi 4 | שליטה ב-GPIO, הרצת סדרות תדרים | GPIO 18 (PWM)<br>GPIO 23, 24 (Direction) |

---

## 2.3.2 תרשים מלבנים

```
┌─────────────────────────────────────────────────────────────────────┐
│                    מערכת זיהוי וסיווג רעד פתולוגי                    │
└─────────────────────────────────────────────────────────────────────┘
                                   │
        ┌──────────────────────────┼──────────────────────────┐
        │                          │                          │
        ▼                          ▼                          ▼
┌───────────────┐          ┌───────────────┐          ┌───────────────┐
│  מערכת רכישה   │          │  מערכת עיבוד   │          │ מערכת אימות    │
│    ESP32      │◄────────►│ Raspberry Pi 4│          │ Motor Control │
└───────────────┘   USB    └───────────────┘          └───────────────┘
        │            Serial        │                          │
        │                          │                          │
┌───────▼───────┐          ┌───────▼───────┐          ┌───────▼───────┐
│   MPU6050     │          │  DSP Engine   │          │   L298N       │
│  (Ax,Ay,Az)   │          │ • Butterworth │          │ Motor Driver  │
│   100 Hz      │          │ • Welch PSD   │          │  PWM Control  │
└───────┬───────┘          │ • Classifier  │          └───────┬───────┘
        │                  └───────┬───────┘                  │
        │                          │                          │
┌───────▼───────┐          ┌───────▼───────┐          ┌───────▼───────┐
│  OLED Display │          │  GUI Output   │          │   DC Motor    │
│  LED Status   │          │ 4-Tab MATLAB  │          │ Tremor Sim.   │
│  Button Ctrl  │          │  Interface    │          │  4-10 Hz      │
└───────────────┘          └───────────────┘          └───────────────┘
```

**איור 1: תרשים מלבנים כללי של המערכת**

---

## 2.3.3 עקרון פעולת המערכת

### זרימת נתונים:

**שלב 1: רכישת נתונים (ESP32)**
1. המשתמש לוחץ על לחצן ההתחלה → LED ירוק נדלק
2. חיישן MPU6050 דוגם תאוצה תלת-צירית (Ax, Ay, Az) בקצב 100 Hz
3. הנתונים נשמרים ב-FIFO Buffer (1024 דגימות)
4. כל דגימה מועברת ב-USB Serial בפורמט: "timestamp,ax,ay,az\n"
5. תצוגת OLED מציגה מספר דגימות נוכחי וזמן הקלטה
6. הקלטה נמשכת עד 120 שניות או עד לחיצה על הלחצן

**שלב 2: העברת נתונים (USB Serial)**
1. Raspberry Pi קולט נתונים ב-115200 baud
2. הנתונים נכתבים ל-CSV file בזמן אמת
3. בסיום הקלטה: קובץ CSV מכיל ~12,000 שורות (100 Hz × 120s)

**שלב 3: עיבוד אותות (Raspberry Pi)**
1. טעינת קובץ CSV ופרסור לערכי Ax, Ay, Az
2. הסרת DC offset (gravity removal): `ax_clean = ax - mean(ax)`
3. סינון Butterworth Order 4:
   - 3-12 Hz (Combined tremor band)
   - 3-7 Hz (Rest tremor band)
   - 6-12 Hz (Essential tremor band)
4. חישוב Resultant Vector: `resultant = sqrt(ax² + ay² + az²)`
5. ניתוח PSD בשיטת Welch (4s windows, 50% overlap)
6. חישוב מדדים:
   - RMS per axis and resultant
   - Band Power (trapezoidal integration)
   - Dominant Frequency (peak detection)
   - Power Ratio = Power_Rest / Power_Essential

**שלב 4: סיווג (Classification)**
```python
if power_ratio > 2.0:
    classification = "Rest Tremor (Parkinsonian)"
    confidence = "High"
elif power_ratio < 0.5:
    classification = "Essential Tremor (Postural)"
    confidence = "High"
else:
    classification = "Mixed Tremor"
    confidence = "Moderate"
```

**שלב 5: ויזואליזציה (GUI)**
- **Tab 1:** Bode plots + Clinical Metrics table
- **Tab 2:** Dominant Axis Analysis (time-domain)
- **Tab 3:** Resultant Vector Analysis (time-domain)
- **Tab 4:** PSD Analysis + Band Power Comparison

**שלב 6: שמירת נתונים**
- קובץ CSV מקורי נשמר בתיקייה `tremor_data/`
- גרפים מיוצאים כתמונות PNG (אופציונלי)
- לוג ריצה נשמר לקובץ `analysis.log`

---

# פרק 3: רקע תיאורטי ועקרונות עיבוד אותות

## 3.1 רעד פתולוגי - סקירה קלינית

### 3.1.1 רעד מנוחה (Rest Tremor)

**הגדרה:**
רעד המופיע כאשר חלק הגוף נמצא במנוחה מוחלטת, ללא הפעלה שרירית אקטיבית, ומיטב בעת פעילות רצונית.

**מאפיינים:**
- **טווח תדרים:** 3-7 Hz (בעיקר 4-6 Hz)
- **מחלה נפוצה:** מחלת פרקינסון (Parkinson's Disease)
- **איברים מושפעים:** ידיים, רגליים, לסת
- **תבנית תנועה:** "pill-rolling" (גלילת כדור) ביד

**פתופיזיולוגיה:**
הרעד נגרם מפעילות לא תקינה של הגרעינים הבזאליים (Basal Ganglia) וירידה ברמות הדופמין. מעגלי המוטור-קורטקס-תלמוס מייצרים פעילות אוסצילטורית בתדר נמוך.

**מדדים כמותיים:**
- **RMS Amplitude:** 0.5-3.0 m/s² (גבוה)
- **Dominant Frequency:** 4-6 Hz
- **Power in 3-7 Hz:** גבוה
- **Power Ratio (Rest/Essential):** > 2.0

### 3.1.2 רעד אסנציאלי (Essential Tremor)

**הגדרה:**
רעד המופיע בעיקר בזמן פעילות רצונית או החזקת תנוחה (postural tremor), ומיטב בעת מנוחה.

**מאפיינים:**
- **טווח תדרים:** 6-12 Hz (בעיקר 8-10 Hz)
- **מחלה נפוצה:** Essential Tremor (ET)
- **איברים מושפעים:** ידיים, ראש, קול
- **תבנית תנועה:** רעד סימטרי דו-צדדי

**פתופיזיולוגיה:**
הרעד נגרם מחוסר תיאום בין המוח הקטן (Cerebellum) לבין מעגלי המוטור. הגורם המדויק אינו ידוע, אך ישנו מרכיב גנטי חזק.

**מדדים כמותיים:**
- **RMS Amplitude:** 0.3-2.0 m/s² (בינוני-גבוה)
- **Dominant Frequency:** 8-10 Hz
- **Power in 6-12 Hz:** גבוה
- **Power Ratio (Rest/Essential):** < 0.5

### 3.1.3 רעד מעורב (Mixed Tremor)

**הגדרה:**
רעד המציג מאפיינים של שני הסוגים - גם רעד מנוחה וגם רעד פוסטורלי.

**מאפיינים:**
- **טווח תדרים:** 3-12 Hz (שני פיקים בPSD)
- **מחלות נפוצות:** Parkinson's + Essential Tremor, Atypical Parkinsonianism
- **מורכבות אבחנתית:** דורש הערכה מעמיקה ע"י נוירולוג

**מדדים כמותיים:**
- **Power Ratio:** 0.5 < ratio < 2.0
- **PSD:** שני פיקים בולטים (אחד ב-3-7 Hz, אחד ב-6-12 Hz)

---

## 3.2 עיבוד אותות דיגיטלי

### 3.2.1 סינון Butterworth

**למה נדרש סינון?**

אות הפלט מחיישן MPU6050 מכיל:
1. **רכיב DC (כבידה):** ~9.8 m/s² בכיוון הכבידה
2. **רעד פתולוגי:** 3-12 Hz - זה מה שאנחנו רוצים!
3. **תנועות רצוניות:** <3 Hz - צריך להסיר
4. **רעש תדר גבוה:** >12 Hz - צריך להסיר

**מסנן Butterworth - מדוע נבחר?**

1. **Flat Passband:** אין אדוות (ripples) בטווח המעבר
2. **Smooth Roll-off:** ירידה הדרגתית בתדרים מחוץ לטווח
3. **Zero-Phase Filtering:** שימוש ב-`filtfilt()` שומר על פאזה

**פרמטרים:**

**טבלה 4: פרמטרי סינון Butterworth**

| Filter Name | Low Cutoff | High Cutoff | Order | Roll-off | Purpose |
|-------------|------------|-------------|-------|----------|---------|
| Combined | 3 Hz | 12 Hz | 4 | 48 dB/octave | סינון כללי של רעד |
| Rest Band | 3 Hz | 7 Hz | 4 | 48 dB/octave | בידוד רעד מנוחה |
| Essential Band | 6 Hz | 12 Hz | 4 | 48 dB/octave | בידוד רעד אסנציאלי |

**תגובת תדר:**

מסנן Butterworth Order 4:
- **Passband:** attenuation < 3 dB
- **Stopband:** attenuation > 40 dB at 2× cutoff
- **Transition width:** ~2 Hz

**מימוש:**
```python
from scipy.signal import butter, filtfilt

# Create filter
order = 4
fs = 100  # sampling rate
nyquist = fs / 2
low = 3 / nyquist
high = 12 / nyquist
b, a = butter(order, [low, high], btype='band')

# Apply zero-phase filtering
filtered = filtfilt(b, a, signal)
```

### 3.2.2 ניתוח PSD - שיטת Welch

**מה זה PSD (Power Spectral Density)?**

PSD מראה כיצד הספק (power) של האות מתפלג על פני תדרים. יחידות: m²/s⁴/Hz

**למה Welch's Method?**

1. **הפחתת רעש:** חלוקה לחלונות + מיצוע מקטינים את השונות
2. **Trade-off:** רזולוציה נמוכה יותר אבל אמינות גבוהה יותר
3. **סטנדרט:** שיטה מקובלת במחקר רפואי

**פרמטרים:**

**טבלה 5: פרמטרי ניתוח Welch PSD**

| Parameter | Value | Justification |
|-----------|-------|---------------|
| Window Length | 4 seconds | רזולוציה: 1/4 = 0.25 Hz |
| Overlap | 50% | איזון בין רזולוציה לשונות |
| Window Type | Hann | מקטין leakage ספקטרלי |
| Sampling Rate | 100 Hz | Nyquist: 50 Hz (מספק ל-12 Hz) |
| Frequency Resolution | 0.25 Hz | מספק להפרדת 3-7 Hz מ-6-12 Hz |

**מימוש:**
```python
from scipy.signal import welch

# Calculate PSD
freq, psd = welch(
    signal,
    fs=100,           # sampling rate
    window='hann',    # Hann window
    nperseg=400,      # 4 seconds × 100 Hz
    noverlap=200,     # 50% overlap
    scaling='density' # PSD units: m²/s⁴/Hz
)
```

**פרשנות:**

- **Peak in 3-7 Hz:** מעיד על רעד מנוחה
- **Peak in 6-12 Hz:** מעיד על רעד אסנציאלי
- **Two peaks:** מעיד על רעד מעורב

### 3.2.3 אינטגרציה טרפזואידית לחישוב הספק

**מה זה Band Power?**

Band Power הוא האינטגרל של ה-PSD על פני טווח תדרים:

```
Power = ∫ PSD(f) df
```

**למה אינטגרציה טרפזואידית (Trapezoidal)?**

1. **דיוק:** טוב יותר מסכימה פשוטה (np.sum)
2. **יחידות נכונות:** np.sum משאיר יחידות של m²/s⁴/Hz, אנחנו רוצים m²/s⁴
3. **סטנדרט:** שיטה מקובלת במחקר

**השוואה:**

```python
# ❌ WRONG: np.sum - לא לוקח בחשבון Δf
power_wrong = np.sum(psd[mask])
# Units: m²/s⁴/Hz (לא נכון!)

# ✅ CORRECT: np.trapz - אינטגרציה נכונה
power_correct = np.trapz(psd[mask], freq[mask])
# Units: m²/s⁴ (נכון!)
```

**מימוש:**
```python
import numpy as np

# Define frequency masks
rest_mask = (freq >= 3) & (freq <= 7)
ess_mask = (freq >= 6) & (freq <= 12)

# Calculate band power using trapezoidal integration
power_rest = np.trapz(psd[rest_mask], freq[rest_mask])
power_ess = np.trapz(psd[ess_mask], freq[ess_mask])

# Calculate power ratio for classification
power_ratio = power_rest / power_ess
```

---

## 3.3 מדדים קליניים

### 3.3.1 RMS (Root Mean Square)

**הגדרה:**
RMS הוא מדד לעוצמה "ממוצעת" של האות:

```
RMS = sqrt(mean(signal²))
```

**משמעות קלינית:**
- מדד לחומרת הרעד (tremor severity)
- יחידות: m/s²
- טווח:
  - Mild: < 0.10 m/s²
  - Moderate: 0.10-0.30 m/s²
  - Severe: > 0.30 m/s²

**שימוש בפרויקט:**
- **Axis RMS:** RMS של ציר בודד (X/Y/Z) - מראה כיווניות
- **Resultant RMS:** RMS של Resultant Vector - מראה עוצמה כללית

### 3.3.2 Band Power

**הגדרה:**
אינטגרל ה-PSD על טווח תדרים מסוים (ראה 3.2.3)

**משמעות קלינית:**
- מדד לאנרגיה בטווח תדר ספציפי
- יחידות: m²/s⁴
- שימוש: הפרדה בין רעד מנוחה לרעד אסנציאלי

**דוגמה:**
```
Power_rest = 6.50 m²/s⁴ (high)
Power_essential = 8.80 m²/s⁴ (low)
→ Suggests Rest Tremor
```

### 3.3.3 Power Ratio

**הגדרה:**
```
Power Ratio = Power_Rest / Power_Essential
```

**קריטריון סיווג:**
- **Ratio > 2.0:** Rest Tremor (Parkinsonian) - High Confidence
- **0.5 < Ratio < 2.0:** Mixed Tremor - Moderate Confidence
- **Ratio < 0.5:** Essential Tremor - High Confidence

**דוגמה:**
```
Power_rest = 4.10 m²/s⁴
Power_essential = 1.94 m²/s⁴
Ratio = 4.10 / 1.94 = 2.11

→ Classification: Rest Tremor (High Confidence)
```

---

**[להמשיך לפרק 4...]**

---

**הערה:** זהו החלק הראשון של ספר הפרויקט (עמודים 1-17 מתוך ~50). האם תרצה שאמשיך עם:
- פרק 4 (מטלות)?
- פרק 5 (בדיקות ותוצאות)?
- פרק 6 (סיכום)?
- הנספחים (קודים)?

או שמא יש לך שאלות/הערות על החלק הראשון?
